<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Document</title>
    <!-- 引入样式 -->
    <link rel="stylesheet" href="../../plugins/element-ui/index.css"/>
    <link rel="stylesheet" href="../../styles/common.css"/>
    <link rel="stylesheet" href="../../styles/page.css"/>
    <style>
        .addDish .el-input {
            width: 130px;
        }

        .addDish .el-input-number__increase {
            border-left: solid 1px #FFE1CA;
            background: #fff3ea;
        }

        .addDish .el-input-number__decrease {
            border-right: solid 1px #FFE1CA;
            background: #fff3ea;
        }

        .addDish input {
            border: 1px solid #ffe1ca;
        }

        .addDish .table {
            border: solid 1px #EBEEF5;
            border-radius: 3px;
        }

        .addDish .table th {
            padding: 5px 0;
        }

        .addDish .table td {
            padding: 7px 0;
        }

        .addDishList .seachDish {
            position: absolute;
            top: 10px;
            right: 20px;
        }

        .addDishList .el-dialog__body {
            padding: 0;
            border-bottom: solid 1px #ccc;
        }

        .addDishList .el-dialog__footer {
            padding-top: 27px;
        }

        .addDish {
            width: 777px;
        }

        .addDish .addBut {
            background: #ffc200;
            display: inline-block;
            padding: 0px 20px;
            border-radius: 3px;
            line-height: 40px;
            cursor: pointer;
            border-radius: 4px;
            color: #333333;
            font-weight: 500;
        }

        .addDish .content {
            background: #fafafb;
            padding: 20px;
            border: solid 1px #ccc;
            border-radius: 3px;
        }

        .addDishCon {
            padding: 0 20px;
            display: flex;
            line-height: 40px;
        }

        .addDishCon .leftCont {
            display: flex;
            border-right: solid 2px #E4E7ED;
            width: 60%;
            padding: 15px;
        }

        /*材料种类长度*/
        .addDishCon .leftCont .tabBut {
            width: 100px;
        }

        .addDishCon .leftCont .tabBut span {
            display: block;
            text-align: center;
            border-right: solid 2px #f4f4f4;
            cursor: pointer;
        }

        .addDishCon .leftCont .act {
            border-color: #fc0c0c !important;
            color: #f70707 !important;
        }

        .addDishCon .leftCont .tabList {
            flex: 1;
            padding: 0px;
        }

        .addDishCon .leftCont .tabList .table {
            border: solid 1px #f4f4f4;
            border-bottom: solid 1px #f4f4f4;
        }

        .addDishCon .leftCont .tabList .table .items {
            border-bottom: solid 1px #f4f4f4;
            padding: 0 10px;
            display: flex;
        }

        .addDishCon .leftCont .tabList .table .items .el-checkbox, .addDishCon .leftCont .tabList .table .items .el-checkbox__label {
            width: 100%;
        }

        .addDishCon .leftCont .tabList .table .items .item {
            display: flex;
            padding-right: 0px;
        }

        .addDishCon .leftCont .tabList .table .items .item span {
            display: inline-block;
            text-align: center;
            flex: 2;
        }

        .addDishCon .ritCont {
            width: 40%;
            padding: 0 5px;
        }

        .addDishCon .ritCont .item {
            box-shadow: 0px 1px 4px 3px rgba(0, 0, 0, 0.03);
            display: flex;
            text-align: center;
            padding: 0 10px;
            margin-bottom: 20px;
            border-radius: 6px;
            color: #818693;

        }

        .addDishCon .ritCont .item span:first-child {
            text-align: left;

            color: #20232A;
            width: 80px;
        }

        .addDishCon .ritCont .item .specification {
            display: inline-block;
            flex: 1;
        }

        .addDishCon .ritCont .item .del {
            cursor: pointer;
        }

        .addDishCon .ritCont .item .del img {
            position: relative;
            top: 5px;
            width: 20px;
        }

        .addDishCon .el-checkbox__label {
            width: 100%;
        }

        #combo-add-app .setmaterial .el-form-item__label::before {
            content: '*';
            color: #F56C6C;
            margin-right: 4px;
        }

        #combo-add-app .uploadImg .el-form-item__label::before {
            content: '*';
            color: #F56C6C;
            margin-right: 4px;
        }
    </style>
</head>
<body>
<div class="addBrand-container" id="combo-add-app">
    <div class="container">
        <el-form
                ref="ruleForm"
                :model="ruleForm"
                :rules="rule"
                :inline="true"
                label-width="180px"
                class="demo-ruleForm"
        >
            <div>
                <el-form-item label="填写人:" v-if="this.actionType=='add'">
                    <el-input  v-model="this.user.name"  :disabled="true"/>
                </el-form-item>
                <el-form-item label="填写人:" v-if="this.actionType !='add'">
                    <el-input  v-model="ruleForm.userName"  :disabled="true"/>
                </el-form-item>

                <el-form-item prop="urgentStatus"  label="紧急状态:"  v-if="this.actionType !='show'">
                    <el-select  v-model="ruleForm.urgentStatus" clearable placeholder="请选择紧急程度">
                        <el-option label="正常" :value="0"></el-option>
                        <el-option label="紧急" :value="1"></el-option>
                        <el-option label="非常紧急" :value="2"></el-option>
                    </el-select>
                </el-form-item>
            </div>

            <div>
                <el-form-item label="选择出库材料:" class="setmaterial">
                    <el-form-item>
                        <div class="addDish">
                            <span v-if="materialTable.length == 0&& this.actionType!='show'" class="addBut" @click="openAddDish"> + 添加出库材料</span>
                            <div v-if="materialTable.length != 0" class="content">
                                <div class="addBut" style="margin-bottom: 20px" @click="openAddDish" v-if="this.actionType!='show'">+ 添加出库材料</div>
                                <div class="table" >
                                    <el-table :data="materialTable" style="width: 100%" align="center">
                                                                                    align="center"></el-table-column>-->
                                        <el-table-column prop="name" label="材料名称" width="180"
                                                         align="center"></el-table-column>
                                        <el-table-column prop="specification" label="材料规格"
                                                         width="200"  align="center"></el-table-column>
                                        <el-table-column prop="unit" label="材料单位" width="110" align="center"></el-table-column>
                                        <el-table-column prop="available" label="仓库总量" width="110"  align="center" ></el-table-column>
                                        <el-table-column prop="amount" label="取出量" width="143"  align="center" >
                                            <template slot-scope="scope">
                                                <el-input-number
                                                        v-model="scope.row.amount"
                                                        size="small"
                                                        :min="0"
                                                        :max="scope.row.available"
                                                        :precision="2" :step="0.01"
                                                        label="描述文字"
                                                ></el-input-number>
                                            </template>
                                        </el-table-column>
                                        <el-table-column prop="number" label="领料次数" width="143"  align="center" >
                                            <template slot-scope="scope">
                                                <el-input-number
                                                        v-model="scope.row.number"
                                                        size="small"
                                                        :min="1"
                                                        label="描述文字"
                                                ></el-input-number>
                                            </template>
                                        </el-table-column>

                                        <el-table-column prop="address" label="操作" width="110px;" align="center" v-if="this.actionType !='show'">
                                            <template slot-scope="scope"  align="center">
                                                <el-button type="text" size="small"
                                                           @click="delDishHandle(scope.$index)"> 删除
                                                </el-button>
                                            </template>
                                        </el-table-column>
                                    </el-table>
                                </div>
                            </div>
                        </div>
                    </el-form-item>
                </el-form-item>
            </div>
            <div class="address">
                <el-form-item label="出库单描述:" v-if="this.actionType!='show'">
                    <el-input v-model="ruleForm.outformDescription" type="textarea" :rows="5" placeholder="出库单描述,(最多500字)"
                              maxlength="500"/>
                </el-form-item>
                <el-form-item label="出库单描述:" v-if="this.actionType=='show'">
                    <el-input v-model="ruleForm.outformDescription" type="textarea" :rows="5" placeholder="出库单描述,(最多500字)"
                              maxlength="500" :disabled="true"/>
                </el-form-item>
            </div>
            <div class="address">
                <el-form-item label="审核结果:" v-if="ruleForm.checkStatus=='2'">
                    <el-input v-model="ruleForm.checkDescription" type="textarea" :rows="5" placeholder="审核单描述,(最多500字)"
                              maxlength="500" :disabled="true"/>
                </el-form-item>
            </div>
            <div class="subBox address">
                <el-form-item>
                    <el-button @click="goBack()"> 取消</el-button>

                    <el-button v-if="this.actionType != 'show'" type="primary" @click="submitForm('ruleForm', false)"> 保存</el-button>
                    <el-button
                            v-if="this.actionType == 'add'"
                            type="primary"
                            class="continue"
                            @click="submitForm('ruleForm', true)"
                    >
                        保存并继续填写出库单
                    </el-button>
                </el-form-item>
            </div>
        </el-form>
    </div>
    <el-dialog
            title="添加材料"
            class="addDishList"
            :visible.sync="dialogVisible"
            width="70%"
            :before-close="handleClose"
    >
        <el-input
                v-model="value"
                class="seachDish"
                placeholder="请输入材料名称进行搜索"
                style="width: 250px"
                size="small"
                clearable
        >
            <i slot="prefix" class="el-input__icon el-icon-search" style="cursor: pointer" @click="seachHandle"></i>
        </el-input>
        <div class="addDishCon">
            <div class="leftCont">
                <div
                        v-show="seachKey.trim() == ''"
                        class="tabBut"
                >
                    <!--                    材料分类列表-->
                    <span
                            v-for="(item, index) in materialType"
                            :key="index"
                            :class="{act:index == keyInd}"
                            @click="checkTypeHandle(index, item.id)"
                    >{{ item.name }}</span>
                </div>

                <!--                选择分类后显示的材料实体-->
                <div class="tabList">
                    <div class="table">
                        <div v-if="materialAddList.length == 0" style="padding-left:10px">
                            暂无材料!
                        </div>
                        <el-checkbox-group
                                v-if="materialAddList.length > 0"
                                v-model="checkedList"
                                @change="checkedListHandle"
                        >
                            <div
                                    v-for="(item, index) in materialAddList"
                                    :key="index"
                                    class="items"
                            >
                                <el-checkbox
                                        :key="index"
                                        :label="item"
                                >
                                    <div class="item">
                                        <span style="text-align: left">{{ item.name }}</span>
                                        <span >{{ item.specification }}</span>
                                        <span >{{ item.available }}</span>
                                    </div>
                                </el-checkbox>
                            </div>
                        </el-checkbox-group>
                    </div>
                </div>
            </div>


            <div class="ritCont">
                <div class="tit">
                    已选材料({{ checkedList.length }})
                </div>
                <div class="items">
                    <div
                            v-for="(item, ind) in checkedList"
                            :key="ind"
                            class="item"
                    >
                        <span>{{ item.name }}</span>
                        <span class="specification">{{ item.specification}} </span>
                        <span >{{ item.available}}</span>
                        <span
                                class="del"
                                @click="delCheck(ind)"
                        >
                             <img
                                     src="../../images/icons/btn_clean@2x.png"
                                     alt=""
                             >
                </span>
                    </div>
                </div>
            </div>
        </div>

        <span slot="footer" class="dialog-footer">
          <el-button @click="handleClose">取 消</el-button>
          <el-button type="primary" @click="addTableList">确 定</el-button>
        </span>
    </el-dialog>
</div>
<!-- 开发环境版本，包含了有帮助的命令行警告 -->
<script src="../../plugins/vue/vue.js"></script>
<script src="../../index0.html"></script>

<!-- 引入组件库 -->
<script src="../../plugins/element-ui/index.js"></script>
<!-- 引入axios -->
<script src="../../plugins/axios/axios.min.js"></script>
<script src="../../js/request.js"></script>
<script src="../../api/material.js"></script>
<script src="../../api/outform.js"></script>
<script src="../../js/validate.js"></script>
<script src="../../js/index.js"></script>
<script>
    new Vue({
        el: '#combo-add-app',
        data() {
            return {
                user:'',
                id: '',
                actionType: '',
                value: '',
                seachKey: '',
                actionType: '',
                materialTable: [],
                dialogVisible: false,
                checkList: [],
                ruleForm: {
                    userName:'',
                    urgentStatus:'',
                    materials:[],
                    outformDescription: '',
                    // amount:'',//取出量
                    // number:''//取出次数
                },
                materialType: [],
                materialAddList: [],
                keyInd: 0,
                searchValue: '',
                checkedList: []//绑定所选菜品
            }
        },
        computed: {
            rule () {
                return {
                    urgentStatus: [{ required: true, message: '请输入紧急状态', trigger: 'blur' }],
                    amount: [{ required: true, message: '请输入领料数量', trigger: 'blur' }],
                    number: [{ required: true, message: '请输入领料次数', trigger: 'blur' }],

                }
            }

        },
        watch:{//监听器，seachkey是否发生变化
            seachKey(value){
                if (value.trim()){
                    this.getMaterialForName(this.seachKey,'已入库')
                }
            },
            checkList(value){ //监听是否发生变化
                this.checkedList = value
            }
        },
        created() {
            //获取当前联系人
            this.user = JSON.parse(localStorage.getItem('userInfo'))
            this.getCategory()
            this.getMaterialList()
            this.id = requestUrlParam('id')
            this.actionType = requestUrlParam('type')
            if (this.actionType!='add' ) {
                this.init()
            }

        },
        mounted() {
        },
        methods: {
            async init() {
                queryOutformById(this.id).then((res) => {
                    if (res.code === 1) {
                        this.ruleForm=res.data
                        this.materialTable=res.data.materials;
                    } else {
                        this.$message.error(res.msg || '操作失败')
                    }
                })
            },
            // 添加材料按钮
            openAddDish() {
                this.seachKey = ''
                this.dialogVisible = true
                //搜索条件清空，材料重新查询，材料类别选第一个重新查询
                this.value = ''
                this.keyInd = 0
                if(this.materialTable.length==0) {
                    this.getMaterialList(this.materialType[0].id)//没有选择材料就每次查询第一个分类的材料数据
                }

            },
            seachHandle() {
                this.seachKey = this.value
            },
            // 关键词搜索材料
            getMaterialForName (name,status) {
                queryMaterialListByName({name,status}).then(res => {
                    if (res.code === 1) {
                        this.materialAddList = res.data
                    } else {
                        this.$message.error(res.msg)
                    }
                })
            },
            // 取消添加出库材料
            handleClose(done) {
                this.dialogVisible = false
                if(this.materialTable.length==0){
                    this.checkList=[];
                }
            },


            goBack() {
                window.parent.menuHandle(
                    {
                        id: '3',
                        name: '出库管理',
                        url: 'page/out/list.html',
                        icon: 'icon-chuku'
                    },
                    false
                )
            },
            // 获取材料分类
            getCategory() {
                getMaterialList().then(res => {
                    if (res.code === 1) {
                        this.materialType = res.data
                        this.getMaterialList(res.data[0].id)
                    } else {
                        this.$message.error(res.msg)
                    }
                })
            },
            //切换分类按钮
            checkTypeHandle (ind,id) {
                this.keyInd = ind
                this.getMaterialList(id)
            },
            // 通过材料分类ID获取材料
            getMaterialList (id) {
                outformMaterialListByCategoryId({categoryId: id}).then(res => {
                    if (res.code === 1) {
                        if (res.data.length == 0) {
                            this.materialAddList = []
                            return
                        }
                        this.materialAddList= res.data; //接收同个分类的所有的材料

                    } else {
                        this.$message.error(res.msg)
                    }
                })
            },
            // 删除某个已选择的材料
            delCheck (ind){
                this.checkedList.splice(ind, 1)//从选择id开始删除一个
            },
            //获取所有选到的数据，并放入checkList中供表单使用
            checkedListHandle () {
                this.getCheckList(this.checkedList)//把当前选择的材料放入CheckList中
            },

            // 获取添加材料数据
            getCheckList(value) {
                this.checkList = [...value]
            },

            // 保存添加材料列表，写入表单显示
            addTableList() {
                this.materialTable = JSON.parse(JSON.stringify(this.checkList))
                this.dialogVisible = false
                // // 添加处理逻辑清空选中list

            },
            // 删除已经保存的材料
            delDishHandle(index) {
                this.materialTable.splice(index, 1)
                this.checkList.splice(index, 1)
            },
            //最终保存
            submitForm(formName, st) {
                this.$refs[formName].validate((valid) => {
                    if (valid) {
                        let prams = { ...this.ruleForm }
                        prams.materials = this.materialTable;
                        if(prams.materials.length < 1){
                            this.$message.error('请选择材料！')
                            return
                        }
                        if(this.ruleForm.urgentStatus==='正常'){
                            this.ruleForm.urgentStatus=0
                        } else if(this.ruleForm.urgentStatus==='紧急'){
                            this.ruleForm.urgentStatus=1
                        }else{
                            this.ruleForm.urgentStatus=2
                        }
                        if (this.actionType == 'add') {
                            //发送请求
                            saveOutform(prams)
                                .then((res) => {
                                    if (res.code === 1) {
                                        this.$message.success('出库单添加成功！')
                                        if (!st) {
                                            this.goBack()
                                        } else {
                                            this.$refs.ruleForm.resetFields()
                                            this.materialList = []
                                            this.materialTable = []
                                            this.ruleForm = {
                                                urgentStatus:'',
                                                materials:[],
                                                outformDescription: ''
                                            }
                                            this.checkList=[]


                                        }
                                    } else {
                                        this.$message.error(res.msg || '操作失败')
                                        this.ruleForm.urgentStatus=null
                                    }
                                })
                                .catch((err) => {
                                    this.$message.error('请求出错了：' + err)
                                })
                        } else {
                            editOutform(prams)
                                .then((res) => {
                                    if (res.code === 1) {
                                        this.$message.success('出库单修改成功！')
                                        this.goBack()
                                    } else {
                                        this.$message.error(res.msg || '操作失败')
                                    }
                                })
                                .catch((err) => {
                                    this.$message.error('请求出错了：' + err)
                                })
                        }
                    } else {
                        return false
                    }
                })
            },


        },
    })
</script>
</body>
</html>
