<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Document</title>
  <!-- 引入样式 -->
  <link rel="stylesheet" href="../../plugins/element-ui/index.css"/>
  <link rel="stylesheet" href="../../styles/common.css"/>
  <link rel="stylesheet" href="../../styles/page.css"/>
  <style>
    .addDish .el-input {
      width: 130px;
    }

    .addDish .el-input-number__increase {
      border-left: solid 1px #FFE1CA;
      background: #fff3ea;
    }

    .addDish .el-input-number__decrease {
      border-right: solid 1px #FFE1CA;
      background: #fff3ea;
    }

    .addDish input {
      border: 1px solid #ffe1ca;
    }

    .addDish .table {
      border: solid 1px #EBEEF5;
      border-radius: 3px;
    }

    .addDish .table th {
      padding: 5px 0;
    }

    .addDish .table td {
      padding: 7px 0;
    }

    .addDishList .seachDish {
      position: absolute;
      top: 10px;
      right: 20px;
    }

    .addDishList .el-dialog__body {
      padding: 0;
      border-bottom: solid 1px #ccc;
    }

    .addDishList .el-dialog__footer {
      padding-top: 27px;
    }

    .addDish {
      width: 777px;
    }

    .addDish .addBut {
      background: #ffc200;
      display: inline-block;
      padding: 0px 20px;
      border-radius: 3px;
      line-height: 40px;
      cursor: pointer;
      border-radius: 4px;
      color: #333333;
      font-weight: 500;
    }

    .addDish .content {
      background: #fafafb;
      padding: 20px;
      border: solid 1px #ccc;
      border-radius: 3px;
    }

    .addDishCon {
      padding: 0 20px;
      display: flex;
      line-height: 40px;
    }

    .addDishCon .leftCont {
      display: flex;
      border-right: solid 2px #E4E7ED;
      width: 60%;
      padding: 15px;
    }

    /*材料种类长度*/
    .addDishCon .leftCont .tabBut {
      width: 100px;
    }

    .addDishCon .leftCont .tabBut span {
      display: block;
      text-align: center;
      border-right: solid 2px #f4f4f4;
      cursor: pointer;
    }

    .addDishCon .leftCont .act {
      border-color: #fc0c0c !important;
      color: #f70707 !important;
    }

    .addDishCon .leftCont .tabList {
      flex: 1;
      padding: 0px;
    }

    .addDishCon .leftCont .tabList .table {
      border: solid 1px #f4f4f4;
      border-bottom: solid 1px #f4f4f4;
    }

    .addDishCon .leftCont .tabList .table .items {
      border-bottom: solid 1px #f4f4f4;
      padding: 0 10px;
      display: flex;
    }

    .addDishCon .leftCont .tabList .table .items .el-checkbox, .addDishCon .leftCont .tabList .table .items .el-checkbox__label {
      width: 100%;
    }

    .addDishCon .leftCont .tabList .table .items .item {
      display: flex;
      padding-right: 0px;
    }

    .addDishCon .leftCont .tabList .table .items .item span {
      display: inline-block;
      text-align: center;
      flex: 2;
    }

    .addDishCon .ritCont {
      width: 40%;
      padding: 0 5px;
    }

    .addDishCon .ritCont .item {
      box-shadow: 0px 1px 4px 3px rgba(0, 0, 0, 0.03);
      display: flex;
      text-align: center;
      padding: 0 10px;
      margin-bottom: 20px;
      border-radius: 6px;
      color: #818693;

    }

    .addDishCon .ritCont .item span:first-child {
      text-align: left;

      color: #20232A;
      width: 80px;
    }

    .addDishCon .ritCont .item .specification {
      display: inline-block;
      flex: 1;
    }

    .addDishCon .ritCont .item .del {
      cursor: pointer;
    }

    .addDishCon .ritCont .item .del img {
      position: relative;
      top: 5px;
      width: 20px;
    }

    .addDishCon .el-checkbox__label {
      width: 100%;
    }

    #combo-add-app .setmaterial .el-form-item__label::before {
      content: '*';
      color: #F56C6C;
      margin-right: 4px;
    }

    #combo-add-app .uploadImg .el-form-item__label::before {
      content: '*';
      color: #F56C6C;
      margin-right: 4px;
    }
  </style>
</head>
<body>
<div class="addBrand-container" id="combo-add-app">
  <div class="container">
    <el-form
            ref="ruleForm"
            :model="ruleForm"
            :rules="rules"
            :inline="true"
            label-width="180px"
            class="demo-ruleForm"
    >
      <div>
        <el-form-item label="填写人:" v-if="this.actionType !='add'">
          <el-input  v-model="ruleForm.userName"  :disabled="true"/>
        </el-form-item>

        <el-form-item label="紧急状态:" prop="urgentStatus" >
          <el-input v-model="ruleForm.urgentStatus"  :disabled="true"/>
        </el-form-item>
      </div>

      <div>
        <el-form-item label="选择入库材料:" class="setmaterial">
          <el-form-item>
            <div class="addDish">
              <div v-if="materialTable.length != 0" class="content">
                <div class="table" >
                  <el-table :data="materialTable" style="width: 100%" align="center">
                    <el-table-column prop="name" label="材料名称" width="120"
                                     align="center"></el-table-column>
                    <el-table-column prop="specification" label="材料规格"
                                     width="180"  align="center"></el-table-column>
                    <el-table-column prop="unit" label="材料单位" width="100" align="center"></el-table-column>
                    <el-table-column prop="available" label="入库量" width="100"  align="center" ></el-table-column>
                    <el-table-column v-if="actionType == 'instorage'" prop="warehouseName" label="仓库号" width="100"  align="center" ></el-table-column>
                    <el-table-column v-if="actionType == 'show'" prop="warehouse.name" label="仓库号" width="100"  align="center" ></el-table-column>
                    <el-table-column  prop="shelf" label="货架" width="100"  align="center" ></el-table-column>
                    <el-table-column v-if="actionType == 'instorage'" label="操作" width="110px;" align="center" v-if="this.actionType !='show'">
                      <template slot-scope="scope"  align="center">
                          <el-button type="text" size="small" v-if="actionType=='instorage'"
                                     @click="inStorage(scope.$index,scope.row)"> 入库
                          </el-button>
                        <!--入库框-->
                        <el-dialog
                                :show-close="false"
                                :close-on-click-modal="false"
                                title="添加材料入库"
                                :visible.sync="storageData.visible"
                                width="30%"
                                :append-to-body="true"
                        >
                          <el-form
                                  ref="storageData"
                                  :model="storageData"
                                  :rules="dialogRule"
                                  class="demo-form-inline"
                                  label-width="100px"


                          >
                            <el-form-item label="仓库："  prop="warehouseId">
                              <el-select v-model="storageData.warehouseId" placeholder="请选择仓库" @change="$forceUpdate()">
                                <el-option v-for="(item, index) in setWarehouseList" :key="index" :label="item.name" :value="item.id" />
                              </el-select>
                            </el-form-item>
                            <el-form-item label="货架：" prop="shelf">
                              <el-input
                                      type="textarea"
                                      :row="5"
                                      v-model="storageData.shelf"
                                      placeholder="请输入所在货架"/>
                            </el-form-item>
                          </el-form>
                          <span
                                  slot="footer"
                                  class="dialog-footer">
                          <el-button
                                  size="medium"
                                  @click="handleClose('storageData')"
                          >取 消</el-button>
                          <el-button
                                  type="primary"
                                  size="medium"
                                  @click="insertStorage('storageData')"
                          >确 定</el-button>
                        </span>
                        </el-dialog>
                      </template>
                    </el-table-column>

                  </el-table>
                </div>
              </div>
            </div>
          </el-form-item>
        </el-form-item>
      </div>
      <div class="address">
        <el-form-item label="入库单描述:" v-if="this.actionType=='show'" :rule="rules">
          <el-input v-model="ruleForm.informDescription" type="textarea" :rows="5" placeholder="入库单描述,(最多500字)"
                    maxlength="500" :disabled="true"/>
        </el-form-item>
      </div>
      <div class="address">
        <el-form-item label="审核结果:" v-if="ruleForm.checkStatus=='1'">
          <el-input v-model="ruleForm.checkDescription" type="textarea" :rows="5" placeholder="审核结果"
                    maxlength="500" :disabled="true"/>
        </el-form-item>
      </div>
      <div class="subBox address">
        <el-form-item>
          <el-button @click="goBack()"> 取消</el-button>
          <el-button @click="exportData()" type="success" icon="el-icon-download">
            导出数据
          </el-button>
          <el-button v-if="this.actionType == 'instorage'" type="primary" @click="submitStorage"> 保存</el-button>
        </el-form-item>
      </div>
    </el-form>
  </div>



</div>
<!-- 开发环境版本，包含了有帮助的命令行警告 -->
<script src="../../plugins/vue/vue.js"></script>
<script src="../../index0.html"></script>

<!-- 引入组件库 -->
<script src="../../plugins/element-ui/index.js"></script>
<!-- 引入axios -->
<script src="../../plugins/axios/axios.min.js"></script>
<script src="../../js/request.js"></script>
<script src="../../api/material.js"></script>
<script src="../../api/inform.js"></script>
<script src="../../api/storage.js"></script>
<script src="../../js/validate.js"></script>
<script src="../../js/index.js"></script>
<script src="../../js/vue-resource.min.js"></script>

<script>
  new Vue({
    el: '#combo-add-app',
    data() {
      return {
        user: '',
        id: '',
        actionType: '',
        value: '',
        materialTable: [],
        index: '',
        table: [],
        warehouseName: '',
        dialogVisible: false,

        ruleForm: {
          userName: '',
          urgentStatus: '',
          materials: [],
          informDescription: ''
        },
        setWarehouseList: [],
        storageData: {
          'title': '材料入库',
          'visible': false,
          'warehouseId': '',
          'shelf': ''
        }
      }
    },
    computed: {
      rule() {
        return {
          urgentStatus: {
            required: true,
            message: '请选择紧急状态',
            trigger: 'change',
          },

        }
      },
      dialogRule() {
        return {
          warehouseId: {required: true, message: '请选择仓库', trigger: 'blur',},
          shelf: {required: true, message: '请选择货架', trigger: 'blur',},
        }
      }

    },

    created() {
      this.id = requestUrlParam('id')
      this.actionType = requestUrlParam('type')
      this.init()
    },
    mounted() {

    },
    methods: {
      async init() {
        queryInformById(this.id).then((res) => {
          if (res.code === 1) {
            this.ruleForm = res.data
            if (this.ruleForm.urgentStatus === 0) {
              this.ruleForm.urgentStatus = '正常'
            } else if (this.ruleForm.urgentStatus === 1) {
              this.ruleForm.urgentStatus = '紧急'
            } else {
              this.ruleForm.urgentStatus = '非常紧急'
            }
            this.materialTable = res.data.materials;
          } else {
            this.$message.error(res.msg || '操作失败')
          }
        })
      },

      //刷新
      handleQuery() {
        this.page = 1;
        this.init();
      },
      // 取消添加入库材料
      handleClose(formName) {
        this.resetForm(formName)
        this.storageData.visible = false
      },
      // 获取仓库分类
      getWarehouseList() {
        getWarehouse().then(res => {
          if (res.code === 1) {
            //通过 map 方法处理返回数据，筛选出想要的数据。
            this.setWarehouseList = res.data.map((obj) => ({...obj, warehouseId: obj.id}))

          } else {
            this.$message.error(res.msg)
          }
          console.log("----仓库列表---------",this.setWarehouseList)
        })
      },
      //根据仓库id获取仓库信息
      async getWarehouseMess(id) {
        await queryWarehouseById(id).then(res => {
          if (String(res.code) === '1') {
            this.warehouseName = res.data.name
          } else {
            this.$message.error(res.msg || '操作失败')
          }
        })
      },
      //对当前需要入库的材料填写入库信息
      inStorage(index, table) {
        this.index = index
        this.table = table
        this.storageData.warehouseId = ''
        this.storageData.shelf = ''
        this.storageData.visible = true
        this.getWarehouseList()
      },

      //保存入库信息到每一行的materialTable中
      insertStorage(formName) {
        //表单校验
        this.$refs[formName].validate((valid) => {
          if (valid) {
            this.materialTable[this.index].warehouseId = this.storageData.warehouseId
            //根据仓库id查询仓库信息
            var _this = this
            this.getWarehouseMess(this.storageData.warehouseId).then(() => {
              _this.materialTable[this.index].warehouseName = this.warehouseName
              _this.materialTable[this.index].shelf = this.storageData.shelf
              _this.storageData.visible = false
              _this.resetForm(formName)

            })

          } else {
            console.log('error submit!!');
            return false;
          }
        });
      },
      //重置表单
      resetForm(formName) {
        this.$refs[formName].resetFields();
      },
    //提交入库信息
    submitStorage() {

          let params = {...this.ruleForm}
          params.materials = this.materialTable

          if (params.urgentStatus ==='正常' ) {
            params.urgentStatus = 0
          } else if (params.urgentStatus === '紧急') {
            params.urgentStatus = 1
          } else if(params.urgentStatus === '非常紧急'){
            params.urgentStatus = 2
          }
          //发送请求
          addStorage(params).then((res) => {
                    if (res.code === 1) {
                      this.$message.success('材料入库成功！')
                      this.goBack()
                    } else {
                      this.$message.error(res.msg || '操作失败')
                    }
                  }).catch((err) => {
                    this.$message.error('请求出错了：' + err)
                  })

    },
    goBack() {
      window.parent.menuHandle(
              {
                id: '3',
                name: '入库单',
                url: 'page/storage/inform.html',
                icon: 'icon-cangpeitubiao_huanhuorukutuihuoruku'
              },
              false
      )},

      // 导出数据
      exportData() {
        const params={
          id:this.id,
        }
        this.$http({
          method: "GET",
          url: `/inform/export`,
          responseType: "blob",
          params
        }).then(res => {
          let blob = new Blob([res.data], { type: "application/vnd.ms-excel" }); // 将服务端返回的文件流（二进制）excel文件转化为blob
            let fileName = "入库单.xls";

          if (window.navigator && window.navigator.msSaveOrOpenBlob) {
            // IE
            window.navigator.msSaveOrOpenBlob(blob, fileName);
          } else {
            let objectUrl = (window.URL || window.webkitURL).createObjectURL(
                    blob
            );
            let downFile = document.createElement("a");
            downFile.style.display = "none";
            downFile.href = objectUrl;
            downFile.download = fileName; // 下载后文件名
            document.body.appendChild(downFile);
            downFile.click();
            document.body.removeChild(downFile); // 下载完成移除元素
            // window.location.href = objectUrl
            window.URL.revokeObjectURL(objectUrl); // 只要映射存在，Blob就不能进行垃圾回收，因此一旦不再需要引用，就必须小心撤销URL，释放掉blob对象。
          }
        })
                .catch(err => {
                  console.log(err);
                });
      },


    },
  })
</script>
</body>
</html>
