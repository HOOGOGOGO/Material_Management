<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Document</title>
  <!-- 引入样式 -->
  <link rel="stylesheet" href="../../plugins/element-ui/index.css"/>
  <link rel="stylesheet" href="../../styles/common.css"/>
  <link rel="stylesheet" href="../../styles/page.css"/>
  <style>
    .addDish .el-input {
      width: 130px;
    }

    .addDish .el-input-number__increase {
      border-left: solid 1px #FFE1CA;
      background: #fff3ea;
    }

    .addDish .el-input-number__decrease {
      border-right: solid 1px #FFE1CA;
      background: #fff3ea;
    }

    .addDish input {
      border: 1px solid #ffe1ca;
    }

    .addDish .table {
      border: solid 1px #EBEEF5;
      border-radius: 3px;
    }

    .addDish .table th {
      padding: 5px 0;
    }

    .addDish .table td {
      padding: 7px 0;
    }

    .addDishList .seachDish {
      position: absolute;
      top: 10px;
      right: 20px;
    }

    .addDishList .el-dialog__body {
      padding: 0;
      border-bottom: solid 1px #ccc;
    }

    .addDishList .el-dialog__footer {
      padding-top: 27px;
    }

    .addDish {
      width: 777px;
    }

    .addDish .addBut {
      background: #ffc200;
      display: inline-block;
      padding: 0px 20px;
      border-radius: 3px;
      line-height: 40px;
      cursor: pointer;
      border-radius: 4px;
      color: #333333;
      font-weight: 500;
    }

    .addDish .content {
      background: #fafafb;
      padding: 20px;
      border: solid 1px #ccc;
      border-radius: 3px;
    }

    .addDishCon {
      padding: 0 20px;
      display: flex;
      line-height: 40px;
    }

    .addDishCon .leftCont {
      display: flex;
      border-right: solid 2px #E4E7ED;
      width: 60%;
      padding: 15px;
    }

    /*材料种类长度*/
    .addDishCon .leftCont .tabBut {
      width: 100px;
    }

    .addDishCon .leftCont .tabBut span {
      display: block;
      text-align: center;
      border-right: solid 2px #f4f4f4;
      cursor: pointer;
    }

    .addDishCon .leftCont .act {
      border-color: #fc0c0c !important;
      color: #f70707 !important;
    }

    .addDishCon .leftCont .tabList {
      flex: 1;
      padding: 0px;
    }

    .addDishCon .leftCont .tabList .table {
      border: solid 1px #f4f4f4;
      border-bottom: solid 1px #f4f4f4;
    }

    .addDishCon .leftCont .tabList .table .items {
      border-bottom: solid 1px #f4f4f4;
      padding: 0 10px;
      display: flex;
    }

    .addDishCon .leftCont .tabList .table .items .el-checkbox, .addDishCon .leftCont .tabList .table .items .el-checkbox__label {
      width: 100%;
    }

    .addDishCon .leftCont .tabList .table .items .item {
      display: flex;
      padding-right: 0px;
    }

    .addDishCon .leftCont .tabList .table .items .item span {
      display: inline-block;
      text-align: center;
      flex: 2;
    }

    .addDishCon .ritCont {
      width: 40%;
      padding: 0 5px;
    }

    .addDishCon .ritCont .item {
      box-shadow: 0px 1px 4px 3px rgba(0, 0, 0, 0.03);
      display: flex;
      text-align: center;
      padding: 0 10px;
      margin-bottom: 20px;
      border-radius: 6px;
      color: #818693;

    }

    .addDishCon .ritCont .item span:first-child {
      text-align: left;

      color: #20232A;
      width: 80px;
    }

    .addDishCon .ritCont .item .specification {
      display: inline-block;
      flex: 1;
    }

    .addDishCon .ritCont .item .del {
      cursor: pointer;
    }

    .addDishCon .ritCont .item .del img {
      position: relative;
      top: 5px;
      width: 20px;
    }

    .addDishCon .el-checkbox__label {
      width: 100%;
    }

    #combo-add-app .setmaterial .el-form-item__label::before {
      content: '*';
      color: #F56C6C;
      margin-right: 4px;
    }

    #combo-add-app .uploadImg .el-form-item__label::before {
      content: '*';
      color: #F56C6C;
      margin-right: 4px;
    }
  </style>
</head>
<body>
<div class="addBrand-container" id="combo-add-app">
  <div class="container">
    <el-form
            ref="ruleForm"
            :model="ruleForm"
            :rules="rule"
            :inline="true"
            label-width="180px"
            class="demo-ruleForm"
    >
      <div>
        <el-form-item label="填写人:" v-if="this.actionType !='add'">
          <el-input  v-model="ruleForm.userName"  :disabled="true"/>
        </el-form-item>

        <el-form-item prop="urgentStatus"  label="紧急状态:"   >
          <el-input v-model="ruleForm.urgentStatus"  :disabled="true"/>
        </el-form-item>
      </div>

      <div>
        <el-form-item label="选择出库材料:" class="setmaterial">
          <el-form-item>
            <div class="addDish">
              <div v-if="materialTable.length != 0" class="content">
                <div class="table" >
                  <el-table :data="materialTable" style="width: 100%" align="center">
                    <el-table-column prop="name" label="材料名称" width="180"
                                     align="center"></el-table-column>
                    <el-table-column prop="specification" label="材料规格"
                                     width="200"  align="center"></el-table-column>
                    <el-table-column prop="unit" label="材料单位" width="110" align="center"></el-table-column>
<!--                    取出量判断-->
                    <el-table-column prop="amount" label="取出量" width="100"  align="center" ></el-table-column>

                    <!--                    领料次数判断-->
                    <el-table-column prop="number" label="领料次数" width="100"  align="center"   ></el-table-column>

                    <el-table-column prop="warehouse.name" label="存放仓库" width="100"  align="center"   ></el-table-column>

                    <el-table-column prop="shelf" label="货架" width="100"  align="center"   ></el-table-column>

                    <el-table-column prop="backAmount" label="退料量" width="100"  align="center"   ></el-table-column>

                    <el-table-column v-if="this.actionType == 'back'" label="操作" width="110px;" align="center" v-if="this.actionType !='show'">
                      <template slot-scope="scope"  align="center">
                        <el-button type="text" size="small"
                                   @click="inStorage(scope.$index,scope.row)"> 退料
                        </el-button>
                        <!--入库框-->
                        <el-dialog
                                :show-close="false"
                                :close-on-click-modal="false"
                                title="退料入库"
                                :visible.sync="storageData.visible"
                                width="30%"
                                :append-to-body="true"
                        >
                          <el-form
                                  ref="storageData"
                                  :model="storageData"
                                  :rules="dialogRule"
                                  class="demo-form-inline"
                                  label-width="100px"


                          >
                            <el-form-item label="退料量：" prop="backAmount">
                              <el-input
                                      type="number"
                                      v-model="storageData.backAmount"
                                      placeholder="请输入退料量"/>
                            </el-form-item>
                          </el-form>
                          <span
                                  slot="footer"
                                  class="dialog-footer">
                          <el-button
                                  size="medium"
                                  @click="handleClose('storageData')"
                          >取 消</el-button>
                          <el-button
                                  type="primary"
                                  size="medium"
                                  @click="insertStorage('storageData')"
                          >确 定</el-button>
                        </span>
                        </el-dialog>
                      </template>


                    </el-table-column>

                  </el-table>
                  </el-table>
                </div>
              </div>
            </div>
          </el-form-item>
        </el-form-item>
      </div>
      <div class="address">

        <el-form-item label="出库单描述:" >
          <el-input v-model="ruleForm.outformDescription" type="textarea" :rows="10" placeholder="出库单描述,(最多500字)"
                    maxlength="500" :disabled="true"/>
        </el-form-item>
      </div>

      <div class="subBox address">
        <el-form-item>
          <el-button @click="goBack()"> 取消</el-button>
          <el-button v-if="this.actionType != 'show'" type="primary" @click="submitStorage"> 保存</el-button>
        </el-form-item>
      </div>
    </el-form>
  </div>


</div>
<!-- 开发环境版本，包含了有帮助的命令行警告 -->
<script src="../../plugins/vue/vue.js"></script>
<script src="../../index0.html"></script>

<!-- 引入组件库 -->
<script src="../../plugins/element-ui/index.js"></script>
<!-- 引入axios -->
<script src="../../plugins/axios/axios.min.js"></script>
<script src="../../js/request.js"></script>
<script src="../../api/material.js"></script>
<script src="../../api/outform.js"></script>
<script src="../../js/validate.js"></script>
<script src="../../js/index.js"></script>
<script>
  new Vue({
    el: '#combo-add-app',
    data() {
      return {
        resource:'',
        user:'',
        id: '',
        actionType: '',
        value: '',
        setMealList: [],
        seachKey: '',

        actionType: '',
        materialTable: [],
        dialogVisible: false,
        checkList: [],
        ruleForm: {
          userName:'',
          urgentStatus:'',
          materials:[],
          informDescription: ''
        },
        materialType: [],
        materialAddList: [],
        keyInd: 0,
        storageData:{
          'title': '退料入库',
          'visible': false,
          'backAmount': '',
        }//退料

      }
    },
    computed: {
      rules() {
        return {
          urgentStatus: {
            required: true,
            message: '请选择紧急状态',
            trigger: 'change',
          },

        }
      },
      dialogRule() {
        return {
          backAmount: {required: true, message: '请输入退料量', trigger: 'blur',},
        }
      }
    },
    watch:{//监听器，seachkey是否发生变化
      seachKey(value){
        if (value.trim()){
          this.getMaterialForName(this.seachKey)
        }
      },
      checkList(value){ //监听是否发生变化
        this.checkedList = value
      }
    },
    created() {
      this.id = requestUrlParam('id')
      this.actionType = requestUrlParam('type')
      this.resource = requestUrlParam('resource')
        this.init()
    },
    mounted() {
    },
    methods: {
      async init() {
        queryOutformById(this.id).then((res) => {
          if (res.code === 1) {
            this.ruleForm=res.data
            if(this.ruleForm.urgentStatus===0){
              this.ruleForm.urgentStatus='正常'
            } else if(this.ruleForm.urgentStatus===1){
              this.ruleForm.urgentStatus='紧急'
            }else{
              this.ruleForm.urgentStatus='非常紧急'
            }
            this.materialTable=res.data.materials;
          } else {
            this.$message.error(res.msg || '操作失败')
          }
        })
      },
      // 添加材料按钮
      openAddDish() {
        this.seachKey = ''
        this.dialogVisible = true
        //搜索条件清空，菜品重新查询，菜品类别选第一个重新查询
        this.value = ''
        this.keyInd = 0
        if(this.materialTable.length==0) {
          this.getMaterialList(this.materialType[0].id)//没有选择材料就每次查询第一个分类的材料数据
        }

      },
      seachHandle() {
        this.seachKey = this.value
      },

      // 取消退料入库
      handleClose(formName) {
        this.resetForm(formName)
        this.storageData.visible = false
      },
      //对当前需要退料入库的材料填写退料量
      inStorage(index, table) {
        this.index = index
        this.table = table
        this.storageData.backAmount = ''
        this.storageData.visible = true
      },
      //保存退料信息到每一行的materialTable中
      insertStorage(formName) {
        //表单校验
        this.$refs[formName].validate((valid) => {
          if (valid) {
            this.materialTable[this.index].backAmount = this.storageData.backAmount
            this.resetForm(formName)
            this.storageData.visible = false
          } else {
            console.log('error submit!!');
            return false;
          }
        });
      },
      //重置表单
      resetForm(formName) {
        this.$refs[formName].resetFields();
      },
      goBack() {
        window.parent.menuHandle(
                {
                  id: '4',
                  name: '退料单',
                  url: 'page/back/list.html',
                  icon: 'icon-tuihuochuzhan'
                },
                false
        )},
      //提交入库信息
      submitStorage() {

        let params = {...this.ruleForm}
        params.materials = this.materialTable

        if (params.urgentStatus ==='正常' ) {
          params.urgentStatus = 0
        } else if (params.urgentStatus === '紧急') {
          params.urgentStatus = 1
        } else if(params.urgentStatus === '非常紧急'){
          params.urgentStatus = 2
        }
        //发送请求
        backStorage(params).then((res) => { //材料管理员直接退库
          if (res.code === 1) {
            this.$message.success('材料退库成功！')
            this.goBack()
          } else {
            this.$message.error(res.msg || '操作失败')
          }
        }).catch((err) => {
          this.$message.error('请求出错了：' + err)
        })

      },
    },
  })
</script>
</body>
</html>
